---
import { Icon } from 'astro-icon/components'
---

<button class="btn btn-square btn-ghost" id="theme-change">
  <label class="swap dark:swap-active">
    <Icon class="swap-on size-6" name="heroicons:sun" />
    <Icon class="swap-off size-6" name="heroicons:moon" />
  </label>
</button>

<!-- https://docs.astro.build/en/tutorial/6-islands/2/#add-client-side-interactivity -->
<script is:inline>
const setTheme = (theme) => {
  document.documentElement.setAttribute('data-theme', theme)
  localStorage.setItem('theme', theme)
}

const theme
  = localStorage.getItem('theme')
  ?? (window.matchMedia('(prefers-color-scheme: dark)').matches
    ? 'dark'
    : 'light')

setTheme(theme)

document
  .getElementById('theme-change')
  .addEventListener('click', async ({ clientX: x, clientY: y }) => {
    const isDark
      = document.documentElement.getAttribute('data-theme') === 'dark'

    // https://vitepress.dev/guide/extending-default-theme#on-appearance-toggle
    // TODO: check reduce motion
    // setTheme(isDark ? 'light' : 'dark')
    const clipPath = [
      `circle(0px at ${x}px ${y}px)`,
      `circle(${Math.hypot(
        Math.max(x, innerWidth - x),
        Math.max(y, innerHeight - y),
      )}px at ${x}px ${y}px)`,
    ]

    await document.startViewTransition(() => setTheme(isDark ? 'light' : 'dark')).ready

    document.documentElement.animate(
      { clipPath: isDark ? clipPath.reverse() : clipPath },
      {
        duration: 400,
        easing: 'ease-out',
        pseudoElement: `::view-transition-${isDark ? 'old' : 'new'}(root)`,
      },
    )
  })
</script>

<style is:global>
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
  }

  /* html[data-theme="light"]::view-transition-old(root),
  html[data-theme="dark"]::view-transition-new(root) {
    z-index: 1;
  }

  html[data-theme="light"]::view-transition-new(root),
  html[data-theme="dark"]::view-transition-old(root) {
    z-index: 9999;
  } */
</style>
